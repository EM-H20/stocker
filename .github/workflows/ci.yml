name: CI Pipeline
on:
  push:
    branches: [ main, develop, euimin ]
  pull_request:
    branches: [ main, develop ]

jobs:
  code-quality:
    name: "ðŸ” Code Quality Check"
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ“š Checkout repository
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: 'stable'
        channel: 'stable'
        cache: true

    - name: ðŸ“¦ Cache pub dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          .dart_tool
        key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-pub-

    - name: ðŸš€ Get dependencies
      run: flutter pub get

    - name: ðŸ” Check code formatting
      run: |
        echo "ðŸŽ¨ Checking Dart code formatting..."
        if dart format --set-exit-if-changed .; then
          echo "âœ… All files are properly formatted!"
        else
          echo "âŒ Some files need formatting. Please run 'dart format .' locally."
          exit 1
        fi

    - name: ðŸ•µï¸ Analyze code quality
      run: |
        echo "ðŸ” Running Flutter analyze..."
        flutter analyze --fatal-infos

    - name: ðŸ“ Generate analysis report
      if: always()
      run: |
        flutter analyze --write=analysis_output.txt || true
        echo "## ðŸ“Š Analysis Report" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat analysis_output.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

  test:
    name: "ðŸ§ª Test Suite"
    runs-on: ubuntu-latest
    needs: code-quality
    strategy:
      matrix:
        flutter-version: ['3.24.x', 'stable']
      fail-fast: false
    
    steps:
    - name: ðŸ“š Checkout repository
      uses: actions/checkout@v4

    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: ðŸ”§ Setup Flutter ${{ matrix.flutter-version }}
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ matrix.flutter-version }}
        channel: 'stable'
        cache: true

    - name: ðŸ“¦ Cache pub dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          .dart_tool
        key: ${{ runner.os }}-pub-${{ matrix.flutter-version }}-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-pub-${{ matrix.flutter-version }}-
          ${{ runner.os }}-pub-

    - name: ðŸ” Verify Flutter installation
      run: flutter doctor -v

    - name: ðŸš€ Get dependencies
      run: flutter pub get

    - name: ðŸ§ª Run tests
      run: |
        echo "ðŸ§ª Running Flutter tests..."
        flutter test --coverage --reporter=json > test_results.json || true
        if [ -f test_results.json ]; then
          echo "ðŸ“Š Test results generated!"
        fi

    - name: ðŸ“Š Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.flutter-version }}
        path: |
          test_results.json
          coverage/
        retention-days: 7

    - name: ðŸ“ˆ Test Summary
      if: always()
      run: |
        echo "## ðŸ§ª Test Results for Flutter ${{ matrix.flutter-version }}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Tests completed" >> $GITHUB_STEP_SUMMARY
        if [ -f coverage/lcov.info ]; then
          echo "- ðŸ“Š Coverage report generated" >> $GITHUB_STEP_SUMMARY
        fi

  build:
    name: "ðŸ—ï¸ Build Check"
    runs-on: ubuntu-latest
    needs: [code-quality, test]
    if: always() && (needs.code-quality.result == 'success')
    
    steps:
    - name: ðŸ“š Checkout repository
      uses: actions/checkout@v4

    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: ðŸ”§ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: 'stable'
        channel: 'stable'
        cache: true

    - name: ðŸ“¦ Cache pub dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          .dart_tool
        key: ${{ runner.os }}-pub-build-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-pub-build-
          ${{ runner.os }}-pub-

    - name: ðŸš€ Get dependencies
      run: flutter pub get

    - name: ðŸ—ï¸ Build debug APK
      run: |
        echo "ðŸ—ï¸ Building debug APK..."
        flutter build apk --debug
        echo "âœ… Debug APK build completed!"

    - name: ðŸ’¾ Upload debug APK
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: build/app/outputs/flutter-apk/app-debug.apk
        retention-days: 7

    - name: ðŸ“± Build Summary
      run: |
        APK_SIZE=$(du -h build/app/outputs/flutter-apk/app-debug.apk | cut -f1)
        echo "## ðŸ—ï¸ Build Results" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Debug APK built successfully" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“± APK Size: $APK_SIZE" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¦ Artifact uploaded for download" >> $GITHUB_STEP_SUMMARY